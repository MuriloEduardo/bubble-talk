<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
<style>
	#bubble-app *{ box-sizing: border-box; }
	#bubble-app a,
	#bubble-app i{
		transition: all 0.3s cubic-bezier(.25,.8,.25,1);
		text-decoration: none;
	}
	#bubble-app{
		position: fixed;
		bottom: 15px;
		right: 15px;
		height: calc(100% - 30px);
		width: 370px;
	}
	#bubble{
		width: 60px;
		height: 60px;
		border-radius: 100%;
		background-size: cover;
		cursor: pointer;
		position: absolute;
		bottom: 0;
		right: 0;
		box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
			transition: all 0.3s cubic-bezier(.25,.8,.25,1);
			animation: .8s bounce;
	}
	#bubble:hover{
		box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
	}
	#bubble:active,
	#bubble:focus{
		box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
	}
	#body-chat {
		position: absolute;
		width: 100%;
		height: calc(100% - 100px);
		background-color: #fff;
		box-shadow: 0 10px 20px rgba(100,100,100,.19), 0 6px 6px rgba(100,100,100,.23);
		top: -50px;
		right: 0;
		border-radius: 10px;
		overflow: hidden;
		transition: all 0.3s cubic-bezier(.25,.8,.25,1);
		opacity: 0;
		font-family: sans-serif;
	}
	#body-chat header {
		width: 100%;
		height: 100px;
		padding: 15px;
		color: #fff;
		background-color: #009688;
		box-shadow: 0 3px 6px rgba(150,150,150,.16), 0 3px 6px rgba(150,150,150,.23);
		transition: all 0.3s cubic-bezier(.25,.8,.25,1);
		position: absolute;
		top: 0;
		left: 0;
		cursor: pointer;
		z-index: 2;
		border-radius: 10px 10px 0 0;
	}
	#bubble-app.openChat #body-chat{
		opacity: 1;
		top: 0;
	}
	#bubble-app.openChat #bubble::before{
		font-family: 'Material Icons';
		content: "close";
		-webkit-font-feature-settings: 'liga';
		-webkit-font-smoothing: antialiased;
		text-rendering: optimizeLegibility;
		-moz-osx-font-smoothing: grayscale;
		font-feature-settings: 'liga';

		width: 60px;
		height: 60px;
		position: absolute;
		top: 0px;
		left: 0px;
		background-color: rgba(255,255,255,.3);
		color: #fff;
		box-sizing: border-box;
		border-radius: 100%;
		text-align: center;
		font-size: 26px;
		line-height: 60px;

		opacity:0;
		-webkit-animation:fadeIn ease-in-out 1;
		-moz-animation:fadeIn ease-in-out 1;
		animation:fadeIn ease-in-out 1;
		-webkit-animation-fill-mode:forwards;
		-moz-animation-fill-mode:forwards;
		animation-fill-mode:forwards;
		-webkit-animation-duration:.3s;
		-moz-animation-duration:.3s;
		animation-duration:.3s;
	}
	/* FADE IN */
	@-webkit-keyframes fadeIn {
		from {
			opacity:0;
		}
		to {
			opacity:1;
			-moz-transform:rotate(90deg);  
			-webkit-transform:rotate(90deg);  
			-o-transform:rotate(90deg);  
			-ms-transform:rotate(90deg);
		}
	}
	@-moz-keyframes fadeIn {
		from {
			opacity:0;
		}
		to {
			opacity:1;
			-moz-transform:rotate(90deg);  
			-webkit-transform:rotate(90deg);  
			-o-transform:rotate(90deg);  
			-ms-transform:rotate(90deg);
		}
	}
	@keyframes fadeIn {
		from {
			opacity:0;
		}
		to {
			opacity:1;
			-moz-transform:rotate(90deg);  
			-webkit-transform:rotate(90deg);  
			-o-transform:rotate(90deg);  
			-ms-transform:rotate(90deg);
		}
	}
	#body-chat footer{
		position: absolute;
		bottom: 0;
		left: 0;
		width: 100%;
		height: auto;
		z-index: 2;
		border-radius: 0 0 10px 10px;
	}
	#body-chat footer textarea{
		resize: none;
		outline: 0;
		width: 100%;
		max-width: 100%;
		height: auto;
		-moz-appearance: textfield;
		-webkit-appearance: textfield;
		appearance: textfield;
		border: none;
		color: #777;
		padding: 22px 115px 8px 15px;
		box-sizing: border-box;
		font-family: sans-serif;
		border-radius: 0 0 10px 10px;
		box-shadow: 0 3px 6px rgba(200,200,200,.16), 0 -3px 6px rgba(200,200,200,.23);
		transition: all 0.3s cubic-bezier(.25,.8,.25,1);
	}
	#body-chat footer textarea:focus{
		box-shadow: 0 3px 6px rgba(200,200,200,.16), 0 -6px 6px rgba(200,200,200,.23);
		padding-left: 20px;
	}
	#body-chat footer textarea::-webkit-input-placeholder,
	#body-chat footer textarea:-moz-placeholder,
	#body-chat footer textarea::-moz-placeholder,
	#body-chat footer textarea:-ms-input-placeholder {
	   color: red;
	   font-size: 14px;
	   font-family: sans-serif;
	}
	#body-chat footer a{
		position: absolute;
		right: 0;
		top: 0;
		background-color: #fff;
		color: #ccc;
		width: 50px;
		text-align: center;
		height: 60px;
		line-height: 74px;
		font-weight: normal;
	}
	#body-chat footer a.emoticos{
		right: 50px;
	}
	#body-chat footer a:hover{
		color: #aaa;
	}
	#body-chat #body{
		background-color: #e5ddd5;
		background-image: url('../img/bg.jpg');
		background-repeat: repeat;
		width: 100%;
		height: calc(100% - 155px);
		padding: 15px 0;
		overflow-y: auto;
		position: relative;
		top: 100px;
		transition: all 0.3s cubic-bezier(.25,.8,.25,1);
		z-index: 1;
	}
	#body-chat #body-conversas{
		width: 100%;
		position: absolute;
		top: 100px;
		transition: all 0.3s cubic-bezier(.25,.8,.25,1);
		z-index: 1;
		background-color: #fff;
		height: 100%;
		overflow-y: auto;
	}
	#h-b-c a{
		position: absolute;
		top: 0;
		width: 45px;
		height: 100px;
		line-height: 114px;
		text-align: center;
		color: rgba(255,255,255,.7);
	}
	#h-b-c a:hover{
		color: #fff;
	}
	#h-b-c .conversas{
		left: 0;
		overflow-y: hidden;
	}
	#h-b-c .conversas i,
	#h-b-c .otherOptinns i {
		line-height: 105px;
	}
	.actions i {
		line-height: 60px;
	}
	#h-b-c .perfilInfos{
		left: 50px;
		right: 50px;
		width: 280px;
		text-align: left;
		padding: 30px 15px 20px 15px;
		line-height: 40px;
	}
	#h-b-c .perfilInfos:hover{
		background-color: rgba(255,255,255,.07);
	}
	#h-b-c .otherOptinns{
		right: 0;
	}
	#h-b-c .otherOptinns.openDropdown i{
		color: #fff;
	}
	.imgApp{
		width: 45px;
		height: 45px;
		border-radius: 100%;
		background-size: cover;
		margin-right: 15px;
		background-color: transparent;
		float: left;
		box-shadow: 0 3px 6px rgba(150,150,150,.16), 0 3px 6px rgba(150,150,150,.23);
	}
	.perfilInfos .descApp{
		float: right;
		width: 185px;
		font-size: 12px;
		line-height: normal;
		padding: 3px 0;
	}
	.perfilInfos .descApp div{ text-overflow: ellipsis; }
	.perfilInfos .descApp div:first-child{
		font-size: 16px;
		margin-bottom: 5px;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		-o-text-overflow: ellipsis;
	}
	.conversasTit{
		font-size: 12px;
		line-height: 21px;
	}
	.conversasTit div:first-child{
		font-size: 16px;
	}
	/* #body.ng-hide-add {
	  animation: .8s fadeOutLeft;
	}
	#body.ng-hide-remove {
	  animation: .8s fadeInLeft;
	} */

	/* Esconde */
	.infosApp.ng-hide-add {
	  animation: .5s fadeOutUp;
	  position: absolute;
	}
	/* Exibe */
	.infosApp.ng-hide-remove {
	  animation: .5s fadeInDown;
	  position: absolute;
	}
	/* Esconde */
	.conversasTit.ng-hide-remove {
	  animation: .5s fadeInDown;
	  position: absolute;
	}
	/* Exibe */
	.conversasTit.ng-hide-add {
	  animation: .5s fadeOutUp;
	  position: absolute;
	}

	/* Esconde */
	#body-chat footer.ng-hide-add,
	#body-chat #body.ng-hide-add {
	  animation: .5s fadeOutRight;
	}
	/* Exibe */
	#body-chat footer.ng-hide-remove,
	#body-chat #body.ng-hide-remove {
	  animation: .5s fadeInRight;
	}




	/* Esconde */
	#body-chat #body-conversas.ng-hide-add {
	  animation: .5s fadeOutLeft;
	}
	/* Exibe */
	#body-chat #body-conversas.ng-hide-remove {
	  animation: .5s fadeInLeft;
	}
	.dropdown-box{
		position: absolute;
		right: 25px;
		top: 65px;
		width: 200px;
		height: auto;
		overflow: hidden;
		background-color: #fff;
		border-radius: 5px 0 5px 5px;
		box-shadow: 0 3px 6px rgba(150,150,150,.16), 0 3px 6px rgba(150,150,150,.23);
	}
	.dropdown-box .listitem{
		padding: 10px 15px;
		font-size: 12px;
		color: #777;
		cursor: pointer;
		transition: all 0.3s cubic-bezier(.25,.8,.25,1);
		line-height: initial;
		text-align: left;
	}
	.dropdown-box .listitem:hover{
		background-color: #f1f1f1;
	}
	.divider-dropdown{
		border-top: solid thin #f9f9f9;
	}
	/* Esconde */
	.dropdown-box.ng-hide-add {
	  animation: .3s zoomOut;
	}
	/* Exibe */
	.dropdown-box.ng-hide-remove {
	  animation: .2s zoomIn;
	}

	.row-msd-uniq {
		position: relative;
		width: 100%;
		height:auto;
		display: block;
		float: left;
	}
	.msg {
		float: right;
		width: auto;
		height: auto;
		padding: 10px;
		margin: 5px 25px;
		border-radius: 7.5px;
		background-color: #dcf8c6;
		font-size: 14px;
		color: #262626;
		position: relative;
		box-shadow: 0 1px 3px rgba(150,150,150,.12), 0 1px 2px rgba(150,150,150,.24);
	}
	.msg::before{
		content: '';
		background-image: url('../img/left-green-arrow.png');
		background-size: 100%;
		position: absolute;
		right: -10px;
		width: 12px;
		height: 19px;
		bottom: 0;
	}
	.msg .hrMsg {
		font-size: 10px;
		float: right;
		padding: 3px 3px 0 10px;
		color: #999;
	}
	.msg.right-msg {
		float: left;
		background-color: #fff;
	}
	.msg.right-msg::before {
		background-image: url('../img/right-white-arrow.png');
		left: -10px;
		right: initial;
	}
	.msg .MsgEmSi,
	.msg .statusMsg,
	.msg .hrMsg {
		display: inline-block;
	}
	.msg .MsgEmSi {
		margin-bottom: 3px;
	}
	.msg .statusMsg {
		float: right;
	}
	.msg .statusMsg i {
		font-size: 15px;
		color: #999
	}
	.msg .statusMsg i.vzldo{ color: #60caf1; }
	.aviso-top-fixed{
		position: absolute;
		width: 250px;
		color: rgba(0,0,0,.95);
		background-color: rgba(255,245,196,.95);
		height: auto;
		left: 50%;
		margin-left: -125px;
		top: 10px;
		z-index: 3;
		font-size: 12px;
		border-radius: 7.5px;
		text-align: center;
		text-shadow: 0 1px 0 rgba(255,255,255,.4);
		padding: 10px;
		box-shadow: 0 1px .5px rgba(0,0,0,.13);
	}
	form {margin:0;}
	.wrapword{
		white-space: -moz-pre-wrap !important;
		white-space: -webkit-pre-wrap;
		white-space: -pre-wrap;
		white-space: -o-pre-wrap;
		white-space: pre-wrap;
		word-wrap: break-word;
		word-break: break-all;
		white-space: normal;
	}
	.eng-cada-canal>a {
		padding: 15px;
		float: left;
		width: 100%;
		color: #777;
	}
	.eng-cada-canal>a:hover {
		background-color: #f9f9f9;
		color: #333;
	}
	.no-img-perfil{
		background-color: transparent;
	    background-image: url('https://s-media-cache-ak0.pinimg.com/originals/dd/0f/d5/dd0fd59858519e2772b20e3c8f9bc004.jpg') !important;
	}
	.eng-cada-canal .pri-des {
		margin: 5px 0;
	}
	.sub-des {
		font-size: 12px;
		margin-top: 5px;
	}
	.bubble-all {
    	padding: 80px 0 15px 0 !important;
	}
	.dropdownEmoji-box {
		position: absolute;
		bottom: 75px;
		right: 5px;
		width: 200px;
		min-height: 30px;
		height: auto;
		background-color: #fff;
		border-radius: 5px;
		box-shadow: 0 3px 6px rgba(150,150,150,.16), 0 3px 6px rgba(150,150,150,.23);
	}
	.dropdownEmoji-box::before {
		content: '';
		position: absolute;
		bottom: -9px;
		right: 10px;
		width: 0; 
		height: 0; 
		border-left: 10px solid transparent;
		border-right: 10px solid transparent;

		border-top: 10px solid #fff;
	}
	/* Esconde */
	.dropdownEmoji-box.ng-hide-add {
	  animation: .3s zoomOut;
	}
	/* Exibe */
	.dropdownEmoji-box.ng-hide-remove {
	  animation: .2s zoomIn;
	}
	.loading:after {
	  overflow: hidden;
	  display: inline-block;
	  vertical-align: bottom;
	  -webkit-animation: ellipsis steps(4,end) 900ms infinite;      
	  animation: ellipsis steps(4,end) 900ms infinite;
	  content: "\2026"; /* ascii code for the ellipsis character */
	  width: 0px;
	}

	@keyframes ellipsis {
	  to {
	    width: 1.25em;    
	  }
	}

	@-webkit-keyframes ellipsis {
	  to {
	    width: 1.25em;    
	  }
	}
</style>
<div id="bubble-app" ng-class="{'openChat': openChatF}" ng-app="bubble-app">
	<div id="body-chat" ng-controller="chatCtrl" ng-init="cliente.bubble_id='57a162fc1918b4b808f2879a'">
		<header id="h-b-c">
			<a href="javascript:void(0)" class="conversas" ng-click="openConversasF=!openConversasF">
				<i class="material-icons" ng-show="!openConversasF">&#xE0BF;</i>
				<i class="material-icons" ng-show="openConversasF">&#xE5C4;</i>
			</a>
			<a href="javascript:void(0)" id="perfilInfos" class="perfilInfos">
				<div class="infosApp" ng-show="!openConversasF">
					<div id="foto-perfil" class="imgApp" ng-class="{'no-img-perfil': !cliente.img_perfil}" ng-style="{'background-image': 'url()'}"></div>
					<div class="descApp">
						<div>{{conversa.nome || conversa.dados.appname}}</div>
						<div class="sub-des"><span ng-class="{'loading': cliente.digitando}">{{cliente.digitando ? 'digitando ' : 'última mensagem às 15:32'}}</span></div>
					</div>
				</div>
				<div class="conversasTit" ng-show="openConversasF">
					<div>Conversas</div>
					<div>com {{getConversas(cliente.bubble_id).dados.appname}}</div>
				</div>
			</a>
			<a href="javascript:void(0)" class="otherOptinns" ng-class="{'openDropdown': dropdownOtherOptions}" ng-focus="dropdownOtherOptions=!dropdownOtherOptions" ng-blur="dropdownOtherOptions=!dropdownOtherOptions">
				<i class="material-icons">&#xE5D4;</i>
				<div class="dropdown-box" ng-show="dropdownOtherOptions" ng-click="dropdownOtherOptionsIn=true">
					<div class="listitem" ng-click="meusDadosView=true">Sua Informações</div>
					<div class="listitem divider-dropdown">Relatar Problema</div>
					<div class="listitem">Conheça o Bubble Talk</div>
				</div>
			</a>
		</header>
		<!-- Chat -->
		<div id="body" ng-show="!openConversasF" ng-class="{'bubble-all': !cliente.conversa_particular && cliente.canal_atual == cliente.bubble_id}">
			<div class="aviso-top-fixed" ng-if="!cliente.conversa_particular && cliente.canal_atual == cliente.bubble_id">
				Quando o primeiro da equipe lhe responder, se iniciará uma conversa particular.
			</div>
			<div ng-repeat="msg in conversa.conversas" class="row-msd-uniq">
				<div class="msg" ng-class="{'right-msg': msg.remetente}">
					<div class="MsgEmSi wrapword">{{msg.mensagem}}</div>
					<div class="statusMsg" ng-if="!msg.remetente">
						<i class="material-icons" ng-class="{'vzldo': msg.visulizada}">&#xE877;</i>
					</div>
					<div ng-bind="msg.data | date:'HH:mm'" class="hrMsg"></div>
				</div>
			</div>
		</div>
		<footer ng-show="!openConversasF">
			<form name="chatForm">
				<textarea placeholder="Digite uma mensagem" ng-model="message" ng-change="typing()" enter-submit="enviaMsg(message)"></textarea>
				<a href="javascript:void(0)" class="actions emoticos" ng-class="{'openDropdown': dropdownEmoji}" ng-focus="dropdownEmoji=!dropdownEmoji" ng-blur="dropdownEmoji=!dropdownEmoji">
					<i class="material-icons">&#xE420;</i>
					<div class="dropdownEmoji-box" ng-show="dropdownEmoji" ng-click="dropdownOtherOptionsIn=true">
					</div>
				</a>
				<a href="#" class="actions anexo" ng-show="!message">
					<i class="material-icons">&#xE226;</i>
				</a>
				<a href="javascript:void(0)" ng-click="enviaMsg(message)" class="actions send" ng-show="message">
					<i class="material-icons">&#xE163;</i>
				</a>
			</form>
		</footer>
		<!-- Listagem das Conversas -->
		<div id="body-conversas" ng-show="openConversasF">
			<div ng-repeat="conversa in conversas" class="eng-cada-canal" ng-hide="cliente.particular && conversa._id == cliente.bubble_id">
				<a href="javascript:void(0)" ng-click="trocarCanal(conversa._id)">
					<div id="foto-perfil" class="imgApp" ng-class="{'no-img-perfil': !cliente.img_perfil}" ng-style="{'background-image': 'url()'}"></div>
					<div class="pri-des">{{conversa.nome || conversa.dados.appname}}</div>
					<div class="sub-des">Última mensagem à 13 min atrás</div>
					<div ng-repeat="msg in messages" ng-if="msg.conversa == 0">
						<div ng-bind="msg.criado | date:'HH:mm'" ng-if="$last"></div>
					</div>
				</a>
			</div>
		</div>
	</div>
	<div id="bubble" ng-click="openChatF=!openChatF" ng-class="{'no-img-perfil': !cliente.img_perfil}"></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular-local-storage/0.5.0/angular-local-storage.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.8/angular-animate.min.js" type="text/javascript"></script>
<script src="https://cdn.socket.io/socket.io-1.4.5.js" type="text/javascript"></script>
<script>
	
	var ba  = document.getElementById('bubble-app');
	var b   = document.getElementById('bubble');

	function fixPageXY(e) {
		if (e.pageX == null && e.clientX != null ) { 
			var html = document.documentElement;
			var body = document.body;
			e.pageX = e.clientX + (html.scrollLeft || body && body.scrollLeft || 0);
			e.pageX -= html.clientLeft || 0;
			e.pageY = e.clientY + (html.scrollTop || body && body.scrollTop || 0);
			e.pageY -= html.clientTop || 0;
		}
	}

	b.onmousedown = function() {
		document.onmousemove = function(e) {
			fixPageXY(e);

			var toTop  = e.pageY-(ba.offsetHeight - 30);
			var toLeft = e.pageX-340;
			
			ba.style.left = toLeft + 'px';
			ba.style.top  = toTop + 'px';
		}
		this.onmouseup = function() {
			document.onmousemove = null;
		}
	}

	angular.module('bubble-app', ['ngAnimate', 'LocalStorageModule']).controller('chatCtrl', function($scope, $http, localStorageService, $filter, $timeout){

		var socket = io.connect('http://127.0.0.1:4000/');
		
		// Eu aqui, sou um cliente
		$scope.cliente = {
			canal_atual: undefined,
			socket_id: undefined,
			digitando: undefined
		}

		$scope.conversa = {};
		$scope.conversas = [];

		$scope.safeApply = function(fn) {
			var phase = this.$root.$$phase;
			if(phase == '$apply' || phase == '$digest') {
				if(fn && (typeof(fn) === 'function')) {
					fn();
				}
			} else {
				this.$apply(fn);
			}
		};

		var updateClienteStorage = function() {
			localStorageService.set('usuario', $scope.cliente);
		}

		$scope.getcliente = function() {
			return localStorageService.get('usuario');
		}

		$scope.getConversas = function(id) {
			return $filter('filter')($scope.conversas, {_id: id})[0];
		}

		var displayMsg = function(data) {
			$scope.safeApply(function() {
				$scope.conversa.conversas.push(data);
	        });
		}

		$scope.enviaMsg = function(mensagem) {

			if(!mensagem) return;
			
			var send_mensagem = {
				mensagem: mensagem,
				remetente: false,
				visulizada: false,
				data: new Date()
			}

			$scope.cliente.mensagem = send_mensagem;

			socket.emit('enviar mensagem', $scope.cliente);

			// Reset form
			$scope.message = undefined;
		}

		$scope.typing = function() {
			$scope.safeApply(function() {
				$scope.cliente.digitando = $scope.message ? true : false;
			});
		}

		$scope.trocarCanal = function(canal_id) {
			$scope.cliente.canal_atual = canal_id;
			$scope.openConversasF      = false;
			$scope.conversa 	       = $scope.getConversas(canal_id);
			
			updateClienteStorage();

			socket.emit('trocar canal', canal_id);
		}

		$scope.$watch('cliente.digitando', function() {
			socket.emit('digitando', $scope.cliente);
		});

		socket.on('nova mensagem', function(data) {
			displayMsg(data.mensagem);
		});

		socket.on('digitando', function(data) {
			if(data.socket_id != $scope.cliente.socket_id && data.socket_id == $scope.cliente.canal_atual) {
				$scope.safeApply(function() {
					$scope.cliente.digitando = data.digitando;
				});
			}
		});

		socket.on('change:canal', function(canal) {
			$scope.safeApply(function() {
				$scope.cliente.canal_atual = canal;
				var m = $scope.getConversas(canal);
	        });
	        updateClienteStorage();
		});

		socket.on('change:particular', function(data) {
			var c = $scope.getConversas(data.socket_id);
			if(c.conversas.length) {
				c.conversas.push(data.cliente.mensagens);
			} else{
				c.conversas = data.cliente.mensagens;
			}

			$scope.cliente.particular = true;

			// Administrador clicou na conversa sem dono
			// E agora essa conversa vai ser entre os dois
			$scope.trocarCanal(data.socket_id);
		});

		socket.on('visualizou', function(cliente) {
			for (var i = 0; i < $scope.messages.length; i++) {
				if($scope.messages[i].client_socket_id == cliente.client_socket_id) {
					$scope.safeApply(function() {
						$scope.messages[i].visualizado = true;
					});
				}
			}
		});

		socket.on('conversas', function(data) {

			var e = !localStorageService.get('usuario') ? 'bubble_id' : 'canal_atual';
			var m = $filter('filter')(data, {_id: $scope.cliente[e]})[0];
			var x = $filter('filter')(m.conversas, {socket_id: $scope.cliente.socket_id})[0];
			if(x) m.conversas = x.mensagens;

			$scope.conversas = data;
			$scope.conversa = $filter('filter')(data, {_id: $scope.cliente[e]})[0];
		});

		socket.on('connect', function() {

			// Se ainda não tiver um socket_id no localStorage
			// Primeira vez que acessa
			if(!localStorageService.get('usuario')) {
				$scope.cliente.socket_id = socket.id;
				$scope.cliente.canal_atual = $scope.cliente.bubble_id;
			} else {
				$scope.cliente = localStorageService.get('usuario');
			}

			$scope.trocarCanal($scope.cliente.canal_atual);

			// Real Time Notify
			socket.emit('novo cliente', $scope.cliente);
		});
	}).directive('enterSubmit', function() {
	    return {
	        restrict: 'A',
	        link: function (scope, elem, attrs) {
	       
		        elem.bind('keydown', function(event) {
		          	
		          	var code = event.keyCode || event.which;
		                  
		          	if (code === 13) {
			            if (!event.shiftKey) {
			              event.preventDefault();
			              scope.$apply(attrs.enterSubmit);
			              scope.cliente.digitando = false;
			            }
		          	}
		        });
	        }
	    }
	});
</script>